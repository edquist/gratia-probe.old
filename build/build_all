#!/bin/bash
########################################################################
# build_all
#
# Do the full package and RPM build. Should be invoked from gratia/probe
# area with:
#
#   build/build_all <options> <args>
#
# See build/build_all -h for details.
#
# 2007/09/11 CHG for the Gratia project.
########################################################################

# Defaults
rpmbuild_top=~/rpmbuild
specfile=~/gratia/probe/build/gratia-probe.spec

usage() {
  cat 1>&2 <<EOF
usage: build_all -h
       build_all [-r <rpmbuild-top>] [-s <specfile>] [--] <version> [<release>]

Defaults:
  rpmbuild-top=${rpmbuild_top}
  specfile=${specfile}
  release=1
EOF
  exit 1
}

while getopts :hr:s: OPT; do
    case $OPT in
        h)
	    usage
            ;;
	r)
	    rpmbuild_top="$OPTARG"
	    ;;
	s)
	    specfile="$OPTARG"
	    ;;
	*)
	    usage
    esac
done
shift $[ OPTIND - 1 ]

[[ -n "${1}" ]] || usage
version=${1}
release=${2:-1}

TMP=`mktemp ${TMPDIR:-/tmp}/build_all.XXXXXXXXXX`
if [[ -z "$TMP" ]]; then
  echo "Unable to create temporary file using mktemp" 1>&2
  exit 1
fi
trap "rm $TMP* 2>/dev/null" EXIT

perl -wape '
s&^(\s*Version\s*:\s*).*$&${1}'"${version}"'&i;
s&^(\s*Release\s*:\s*).*$&${1}'"${release}"'&i;
' ${specfile} > "$TMP"

build/package-probe "${version}" common condor pbs-lsf psacct && \
build/populate_SOURCES -r "${rpmbuild_top}" && \
rpmbuild -ba "$TMP" && \
rpmbuild -ba --target=noarch "$TMP" && \
rpmbuild -ba --define='config_itb 1' "$TMP" && \
rpmbuild -ba --define='config_itb 1' --target=noarch "$TMP"
